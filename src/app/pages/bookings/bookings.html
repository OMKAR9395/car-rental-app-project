<section class="bk-wrap">
  <div class="head">
    <div class="title">
      <mat-icon>assignment_turned_in</mat-icon>
      <h1>Bookings Management</h1>
      <span class="sub">Approve, start, complete or cancel bookings</span>
    </div>
    <div class="head-actions">
      <button mat-stroked-button color="primary" (click)="exportCsv()">
        <mat-icon>download</mat-icon> Export
      </button>
    </div>
  </div>

  <!-- Filters -->
  <mat-card class="filters">
    <form class="row g-2 align-items-end" [formGroup]="form">
      <div class="col-12 col-lg-4">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Date range</mat-label>
          <mat-date-range-input [rangePicker]="picker">
            <input matStartDate placeholder="From" formControlName="from">
            <input matEndDate   placeholder="To"   formControlName="to">
          </mat-date-range-input>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>

        <div class="quick">
          <button mat-button type="button" (click)="quick('today')">Today</button>
          <button mat-button type="button" (click)="quick('7d')">Last 7d</button>
          <button mat-button type="button" (click)="quick('30d')">Last 30d</button>
          <button mat-button type="button" (click)="quick('month')">This month</button>
        </div>
      </div>

      <div class="col-6 col-lg-2">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Status</mat-label>
          <mat-select multiple formControlName="status">
            <mat-option value="pending">Pending</mat-option>
            <mat-option value="approved">Approved</mat-option>
            <mat-option value="ongoing">Ongoing</mat-option>
            <mat-option value="completed">Completed</mat-option>
            <mat-option value="cancelled">Cancelled</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="col-6 col-lg-2">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Car types</mat-label>
          <mat-select multiple formControlName="types">
            <mat-option value="hatchback">Hatchback</mat-option>
            <mat-option value="sedan">Sedan</mat-option>
            <mat-option value="suv">SUV</mat-option>
            <mat-option value="luxury">Luxury</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="col-6 col-lg-2">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Locations</mat-label>
          <mat-select multiple formControlName="locations">
            <mat-option value="PNQ">Pune</mat-option>
            <mat-option value="BOM">Mumbai</mat-option>
            <mat-option value="NAG">Nagpur</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="col-6 col-lg-2">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Search</mat-label>
          <input matInput placeholder="Customer / Car / ID" formControlName="q">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>
    </form>
  </mat-card>

  <!-- Bulk actions -->
  <div class="bulk">
    <mat-checkbox
      [indeterminate]="someChecked()"
      [checked]="allChecked()"
      (change)="toggleAll($event.checked, ids())">
      Select all ({{ ids().length }})
    </mat-checkbox>

    <span class="spacer"></span>

    <button mat-stroked-button color="primary" [disabled]="selected().size===0" (click)="bulkApprove()">
      <mat-icon>done_all</mat-icon> Bulk Approve
    </button>
    <button mat-stroked-button color="warn" [disabled]="selected().size===0" (click)="bulkCancel()">
      <mat-icon>block</mat-icon> Bulk Cancel
    </button>
  </div>

  <!-- Table -->
  <mat-card class="panel">
    <div class="panel-head">
      <div class="left">
        <mat-icon>table_rows</mat-icon>
        <h3>Results ({{ filtered().length }})</h3>
      </div>
    </div>

    <div class="table-wrap">
      <table mat-table [dataSource]="filtered()">

        <!-- Select -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let r">
            <mat-checkbox [checked]="selected().has(r.id)"
                          (change)="toggleRow(r.id, $event.checked)"></mat-checkbox>
          </td>
        </ng-container>

        <!-- ID -->
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef> ID </th>
          <td mat-cell *matCellDef="let r">{{ r.id }}</td>
        </ng-container>

        <!-- When -->
        <ng-container matColumnDef="when">
          <th mat-header-cell *matHeaderCellDef> When </th>
          <td mat-cell *matCellDef="let r">
            {{ r.pickAt | date:'MMM d, h:mm a' }} â†’ {{ r.dropAt | date:'MMM d, h:mm a' }}
          </td>
        </ng-container>

        <!-- Loc -->
        <ng-container matColumnDef="loc">
          <th mat-header-cell *matHeaderCellDef> Loc </th>
          <td mat-cell *matCellDef="let r">{{ r.location }}</td>
        </ng-container>

        <!-- Customer -->
        <ng-container matColumnDef="customer">
          <th mat-header-cell *matHeaderCellDef> Customer </th>
          <td mat-cell *matCellDef="let r">{{ r.customer }}</td>
        </ng-container>

        <!-- Car -->
        <ng-container matColumnDef="car">
          <th mat-header-cell *matHeaderCellDef> Car </th>
          <td mat-cell *matCellDef="let r">{{ r.car }}</td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let r">
            <mat-chip-set>
              <mat-chip [class.pill]="true" [class.pend]="r.status==='pending'"
                        [class.appr]="r.status==='approved'"
                        [class.ongo]="r.status==='ongoing'"
                        [class.comp]="r.status==='completed'"
                        [class.canc]="r.status==='cancelled'">
                {{ r.status }}
              </mat-chip>
            </mat-chip-set>
          </td>
        </ng-container>

        <!-- Amount -->
        <ng-container matColumnDef="amt">
          <th mat-header-cell *matHeaderCellDef> Amount </th>
          <td mat-cell *matCellDef="let r">{{ currency(amount(r)) }}</td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let r" class="text-end">
            <button mat-icon-button [matMenuTriggerFor]="m" matTooltip="Actions"><mat-icon>more_vert</mat-icon></button>
            <mat-menu #m="matMenu">
              <button mat-menu-item (click)="approve(r)"  [disabled]="r.status!=='pending'"><mat-icon>check</mat-icon><span>Approve</span></button>
              <button mat-menu-item (click)="start(r)"    [disabled]="r.status!=='approved'"><mat-icon>play_arrow</mat-icon><span>Start</span></button>
              <button mat-menu-item (click)="complete(r)" [disabled]="r.status!=='ongoing'"><mat-icon>flag</mat-icon><span>Complete</span></button>
              <button mat-menu-item (click)="cancel(r)"   [disabled]="r.status==='completed' || r.status==='cancelled'"><mat-icon>block</mat-icon><span>Cancel</span></button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['select','id','when','loc','customer','car','status','amt','actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['select','id','when','loc','customer','car','status','amt','actions'];"></tr>
      </table>
    </div>
  </mat-card>
</section>
