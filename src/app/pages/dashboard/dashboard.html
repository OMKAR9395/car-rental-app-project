<section class="dash-wrap">
  <!-- Header -->
  <div class="dash-head">
    <div class="title">
      <mat-icon>dashboard</mat-icon>
      <h1>Dashboard</h1>
      <span class="sub">Live overview of rentals, revenue & fleet</span>
    </div>

    <div class="actions">
      <button mat-stroked-button color="primary" (click)="refresh()" matTooltip="Refresh data">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
      <button mat-raised-button color="accent" (click)="createBooking()" class="create-btn">
        <mat-icon>add</mat-icon>
        New Booking
      </button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid">
    <mat-card class="kpi kpi-1">
      <div class="kpi-body">
        <div class="icon"><mat-icon>attach_money</mat-icon></div>
        <div class="text">
          <div class="label">Revenue (Today)</div>
          <div class="value">₹{{ totalRevenueToday() | number }}</div>
          <div class="delta up"><mat-icon>trending_up</mat-icon> +8.2%</div>
        </div>
      </div>
    </mat-card>

    <mat-card class="kpi kpi-2">
      <div class="kpi-body">
        <div class="icon"><mat-icon>directions_car</mat-icon></div>
        <div class="text">
          <div class="label">Active Rentals</div>
          <div class="value">{{ activeRentals() }}</div>
          <div class="muted">live trips in progress</div>
        </div>
      </div>
    </mat-card>

    <mat-card class="kpi kpi-3">
      <div class="kpi-body">
        <div class="icon"><mat-icon>event_available</mat-icon></div>
        <div class="text">
          <div class="label">New Bookings</div>
          <div class="value">{{ newBookings() }}</div>
          <div class="delta up"><mat-icon>north_east</mat-icon> +3 today</div>
        </div>
      </div>
    </mat-card>

    <mat-card class="kpi kpi-4">
      <div class="kpi-body">
        <div class="icon"><mat-icon>speed</mat-icon></div>
        <div class="text">
          <div class="label">Fleet Utilization</div>
          <div class="value">{{ fleetUtil() }}%</div>
          <mat-progress-bar mode="determinate" [value]="fleetUtil()"></mat-progress-bar>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Middle Row -->
  <div class="mid-grid">
    <!-- Fleet by Location -->
    <mat-card class="panel">
      <div class="panel-head">
        <div class="left">
          <mat-icon>location_on</mat-icon>
          <h3>Fleet by Location</h3>
        </div>
      </div>

      <div class="fleet-list">
        <div class="fleet-row" *ngFor="let l of fleetByLocation()">
          <div class="meta">
            <span class="loc">{{ l.name }}</span>
            <span class="count">{{ l.used }}/{{ l.total }}</span>
          </div>
          <mat-progress-bar [color]="l.color" mode="determinate" [value]="percent(l.used, l.total)"></mat-progress-bar>
          <div class="pct">{{ percent(l.used, l.total) }}%</div>
        </div>
      </div>
    </mat-card>

    <!-- Revenue Sparkline -->
    <mat-card class="panel">
      <div class="panel-head">
        <div class="left">
          <mat-icon>timeline</mat-icon>
          <h3>Revenue (Last 7 days)</h3>
        </div>
      </div>

      <div class="spark-wrap">
        <svg [attr.viewBox]="'0 0 260 80'" class="spark">
          <defs>
            <linearGradient id="grad" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="#6c5ce7"/>
              <stop offset="100%" stop-color="#48dbfb"/>
            </linearGradient>
          </defs>
          <polyline [attr.points]="sparklinePoints()" fill="none" stroke="url(#grad)" stroke-width="3" />
        </svg>
        <div class="legend">
          <div class="pill">
            <span class="dot"></span>
            ₹{{ revenue7d()[revenue7d().length-1] }}k today
          </div>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Recent Bookings Table -->
  <mat-card class="panel table-panel">
    <div class="panel-head">
      <div class="left">
        <mat-icon>list_alt</mat-icon>
        <h3>Recent Bookings</h3>
      </div>
      <button mat-stroked-button color="primary" (click)="refresh()">
        <mat-icon>refresh</mat-icon> Refresh
      </button>
    </div>

    <div class="table-wrap">
      <table mat-table [dataSource]="rows()">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef> Booking ID </th>
          <td mat-cell *matCellDef="let r"> {{ r.id }} </td>
        </ng-container>

        <ng-container matColumnDef="customer">
          <th mat-header-cell *matHeaderCellDef> Customer </th>
          <td mat-cell *matCellDef="let r"> {{ r.customer }} </td>
        </ng-container>

        <ng-container matColumnDef="car">
          <th mat-header-cell *matHeaderCellDef> Car </th>
          <td mat-cell *matCellDef="let r"> {{ r.car }} </td>
        </ng-container>

        <ng-container matColumnDef="pickup">
          <th mat-header-cell *matHeaderCellDef> Pickup </th>
          <td mat-cell *matCellDef="let r">
            <mat-icon inline>north_east</mat-icon>
            {{ r.pickup | date:'MMM d, h:mm a' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="drop">
          <th mat-header-cell *matHeaderCellDef> Drop </th>
          <td mat-cell *matCellDef="let r">
            <mat-icon inline>south_east</mat-icon>
            {{ r.drop | date:'MMM d, h:mm a' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let r">
            <mat-chip [color]="chipColor(r.status)" selected>{{ r.status }}</mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> </th>
          <td mat-cell *matCellDef="let r" class="row-actions">
            <button mat-icon-button [matMenuTriggerFor]="rowMenu" matTooltip="Actions">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #rowMenu="matMenu">
              <button mat-menu-item (click)="viewRow(r)"><mat-icon>visibility</mat-icon><span>View</span></button>
              <button mat-menu-item (click)="cancelRow(r)" *ngIf="r.status!=='cancelled'"><mat-icon>cancel</mat-icon><span>Cancel</span></button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row        *matRowDef="let r; columns: displayedColumns;" class="data-row"></tr>
      </table>
    </div>
  </mat-card>
</section>
